A2D=function(A){return(2*sqrt(A/pi))}
D2A=function(D){return((D/2)^2*pi)}
source("R/gcdist.R")
# Loading / Managing DataFrames: ColTrans, surv_dat  ----------------------------------------------  ---------
ColTrans=read.csv("./CSV files/ColonyTransitions/ASRAMP23_ColonyTransitions.csv")
#Prepping surv_dat output
surv_dat=ColTrans[,c("Site_Genet","l10_Area_STA","Survival","Genus","Interval","SiteInterval","Site","N_t0","TransitionType","Interval_Years","StartingDate","EndingDate")]
surv_dat=subset(surv_dat,TransitionType!="RECR")
REGIONYR="ASRAMP23" #"MARAMP22"
# Data Load ---------------------------------------------------------------
Col=read.csv(paste0("./CSV files/ColonyLevel/",REGIONYR,"_VitalRates_colonylevel_CLEAN.csv"))
Col$TL_Date=ymd(Col$TL_Date)
# Determine Unique Time Points ---------------------------
#Use YEAR OR DATE_CLUSTER
TP_METHOD="DATE_CLUSTER"
if(TP_METHOD=="YEAR"){
# It would be easiest to assume a single timepoint per sampling year,
uY=sort(unique(Col$Year))
# Make simple lookup
Year_TP_LU=1:length(uY);names(Year_TP_LU)=uY
#Assign TimePoint IDs
Col$TP_ID=Year_TP_LU[as.character(Col$Year)]
}else if(TP_METHOD=="DATE_CLUSTER"){
# but worth checking clustering at Date Level
uD=sort(unique(Col$TL_Date))
uDD=dist(uD)
#Determine best number of TimePoints by clustering
# K=NbClust(data = uD,diss = uDD,distance = NULL,
#          min.nc = 2, max.nc = 10, method = "complete")
#
################################################################################
################################################################################
#Eyeball because Nbclust is failing
################################################################################
################################################################################
Kval=3
#Kval=max(K$Best.partition)
#Check out dendrogram
hcuDD=hclust(uDD)
par(mfrow=c(1,1))
plot(hcuDD,labels=uD);rect.hclust(hcuDD,k=Kval)
#write Date to Time point number Look up table
Date_TP_df=data.frame(ID0=cutree(hcuDD,k=Kval),Date=uD)
#ensure TP # are chronological
ChronID=Date_TP_df %>% group_by(ID0) %>% summarize(mnDate=mean(Date)) %>% arrange(mnDate)
ChronID$IDc=1:nrow(ChronID)
#Build Chronological Lookup
Date_TP_df=left_join(Date_TP_df,ChronID[,c("ID0","IDc")],by="ID0")
Date_TP_LU=Date_TP_df$IDc;names(Date_TP_LU)=Date_TP_df$Date
#Assign TimePoint IDs
Col$TP_ID=Date_TP_LU[as.character((Col$TL_Date))]
}else{
stop("No valid Time Point selection method.")
}
#table(Col$TP_ID,Col$Site)
# Two-Stage Transition Loop - Rbind Aggregation ---------------------------
uTP=sort(unique(Col$TP_ID))
#Loop through one less than the total number of TPs
#site data
SiteData=unique(Col[,c("Island","Site","TP_ID","Year","TL_Date")]) %>% arrange(Site,TP_ID)
#joincols
alljoincols=c("Island","Site","Genus","Site_Genet","TP_ID","Year","TL_Date","SArea","Shape_Area","Shape_Leng","nPatches") #switch to shape_area and shape_perim
byjoincols=c("Island","Site","Genus","Site_Genet")
ColonyTransitions=NULL
for(i_tp in 1:(length(uTP)-1)){
TP_0=i_tp;TP_1=i_tp+1
# TP_0=2; TP_1=3
#For the data across these two time points, only include sites sampled in both years
TP_0sites=SiteData %>% filter(TP_ID == TP_0) %>% select(Site) %>% distinct()
TP_1sites=SiteData %>% filter(TP_ID == TP_1) %>% select(Site) %>% distinct()
SampledSites=intersect(TP_0sites,TP_1sites)
#Subet colonies from sites that span the interval
Col_tp2=Col %>%
filter(TP_ID %in% c(TP_0,TP_1)) %>%
filter(Site %in% SampledSites$Site)
#Count Colonies
tSG=table(Col_tp2$Site_Genet)  #check: table(tSG)
#Colonies with GROW Transitions
GTr=names(tSG[which(tSG==2)])
GTrCol_0=Col_tp2 %>%
filter(Site_Genet %in% GTr) %>%
filter(TP_ID == TP_0) %>%
select(all_of(alljoincols))
GTrCol_1=Col_tp2 %>%
filter(Site_Genet %in% GTr) %>%
filter(TP_ID == TP_1) %>%
select(all_of(alljoincols))
GTrCol=left_join(GTrCol_0,GTrCol_1,by=byjoincols,suffix=c("_STA","_END"))
GTrCol$TransitionTypeSimple="GROW"
#Colonies with RECR/MORT Transitions
RMTr=names(tSG[which(tSG==1)])
#extract data for RECR Trans
RTrCol_1=Col_tp2 %>%
filter(Site_Genet %in% RMTr) %>%
filter(TP_ID == TP_1)  %>%
select(all_of(alljoincols))
#Build Fake TP_0 Dataframe
RTrCol_0=RTrCol_1[,byjoincols]
RTrCol_0$TP_ID=TP_0
RTrCol_0=left_join(RTrCol_0,SiteData,by=c("Island","Site","TP_ID"))
RTrCol_0$Shape_Area=0
RTrCol_0$Shape_Leng=0
RTrCol_0$SArea=0
RTrCol_0$nPatches=0
RTrCol=left_join(RTrCol_0,RTrCol_1,by=byjoincols,suffix=c("_STA","_END"))
RTrCol$TransitionTypeSimple="RECR"
#extract data for MORT Trans
MTrCol_0=Col_tp2 %>%
filter(Site_Genet %in% RMTr) %>%
filter(TP_ID == TP_0)  %>%
select(all_of(alljoincols))
#Build Fake TP_1 Dataframe
MTrCol_1=MTrCol_0[,byjoincols]
MTrCol_1$TP_ID=TP_1
MTrCol_1=left_join(MTrCol_1,SiteData,by=c("Island","Site","TP_ID"))
MTrCol_1$Shape_Area=0
MTrCol_1$Shape_Leng=0
MTrCol_1$SArea=0
MTrCol_1$nPatches=0
MTrCol=left_join(MTrCol_0,MTrCol_1,by=byjoincols,suffix=c("_STA","_END"))
MTrCol$TransitionTypeSimple="MORT"
TP2_Trans=rbind(GTrCol,RTrCol,MTrCol)
ColonyTransitions=rbind(ColonyTransitions,TP2_Trans)
}
#Build Out Colony Transition Data
ColonyTransitions=ColonyTransitions %>%
mutate(
#Interval Name
Interval=paste0(substr(Year_STA,3,4),"_",substr(Year_END,3,4)),
#Transition and Annualization
l10_Area_STA=log10(Shape_Area_STA),
l10_Area_END=log10(Shape_Area_END),
l10TransitionMagnitude=l10_Area_END-l10_Area_STA,
l10_SArea_STA=log10(SArea_STA),
l10_SArea_END=log10(SArea_END),
l10STransitionMagnitude=l10_SArea_END-l10_SArea_STA,
Interval_Years=as.numeric(difftime(TL_Date_END,TL_Date_STA,units = "days"))/365.25,
l10_Area_ENDann=l10_Area_STA+(l10TransitionMagnitude/Interval_Years),
l10_SArea_ENDann=l10_SArea_STA+(l10STransitionMagnitude/Interval_Years),
#Mortality and Survival
Mortality=if_else(TransitionTypeSimple=="MORT",1,0),
Survival=1-Mortality
)
# Transition
colnames(ColonyTransitions)
colnames(ColTrans)
ColTrans$SIG=paste0(substr(ColTrans$Site,1,3),substr(ColTrans$Site,9,11),"_",
substr(year(ColTrans$StartingDate),3,4),leadz(month(ColTrans$StartingDate),2),"-",
substr(year(ColTrans$EndingDate),3,4),leadz(month(ColTrans$EndingDate),2),"_",
ColTrans$Genus_Code)
ColTrans$SIS=paste0(substr(ColTrans$Site,1,3),substr(ColTrans$Site,9,11),"_",
substr(year(ColTrans$StartingDate),3,4),leadz(month(ColTrans$StartingDate),2),"-",
substr(year(ColTrans$EndingDate),3,4),leadz(month(ColTrans$EndingDate),2),"_",
ColTrans$Spec_Code)
Usig=unique(ColTrans$SIG)
Usis=unique(ColTrans$SIS)
Nsig=length(Usig);Nsig
Nsis=length(Usis);Nsis
Name="Streamlined_VR_Models_"
# Load Data to Get Proportion of "True" Recruitment ------------------------------------
#Assign SFM Sites to Sectors
sitemd=read.csv("data/Thesis_Sites_Metadata2.csv");names(sitemd)[1]="Site";names(sitemd)[1]="Site";sitemd$EndingDate=mdy(sitemd$SampleDate.MM.DD.YYYY.)
ColonyLevel <- read.csv("./CSV files/ColonyLevel/ASRAMP23_VitalRates_colonylevel_CLEAN.csv")
GrowthTib=ColonyLevel %>%
filter(TransitionTypeSimple %in% c("GROWTH","SHRINK")) %>%
group_by(SIG,Site,Interval,Genus_Code,StartingDate,EndingDate,Interval_Years) %>%
nest() %>%
mutate(
GrowthMod=map(data,~lm(log10_ESc ~ log10_SS,data=as.data.frame(data))),
g.N=map(data,~length(.$log10_SS)),
g.int=map(GrowthMod,~coef(.)[1]),
g.slp=map(GrowthMod,~coef(.)[2]),
g.var=map(GrowthMod,~(summary(.)$sigma)^2),
g.R2=map(GrowthMod,~summary(.)$adj.r.squared),
g.AIC=map(GrowthMod,~AIC(.)),
) %>%
unnest(c(SIG, Site,Interval,Genus_Code,StartingDate,Interval_Years,EndingDate,g.N,g.int,g.slp,g.var,g.R2,g.AIC)) %>%
select_if(negate(is.list))
ColonyLevel <- read.csv("./CSV files/ColonyTransitions/ASRAMP23_ColonyTransitions.csv")
GrowthTib=ColonyLevel %>%
filter(TransitionTypeSimple %in% c("GROWTH","SHRINK")) %>%
group_by(SIG,Site,Interval,Genus_Code,StartingDate,EndingDate,Interval_Years) %>%
nest() %>%
mutate(
GrowthMod=map(data,~lm(log10_ESc ~ log10_SS,data=as.data.frame(data))),
g.N=map(data,~length(.$log10_SS)),
g.int=map(GrowthMod,~coef(.)[1]),
g.slp=map(GrowthMod,~coef(.)[2]),
g.var=map(GrowthMod,~(summary(.)$sigma)^2),
g.R2=map(GrowthMod,~summary(.)$adj.r.squared),
g.AIC=map(GrowthMod,~AIC(.)),
) %>%
unnest(c(SIG, Site,Interval,Genus_Code,StartingDate,Interval_Years,EndingDate,g.N,g.int,g.slp,g.var,g.R2,g.AIC)) %>%
select_if(negate(is.list))
ColonyLevel %>%
filter(TransitionTypeSimple %in% c("GROWTH")) %>%
filter(Genus_Code=="POSP"&REGION=="MHI") %>%
ggplot(aes(x=StartingSummedPatchDiam,
y=100*(MonthlyPropRate_E-1),color=NfragBin))+#y=log10(TransitionRate_L)
geom_point(alpha=.1)+
stat_smooth(method="loess",span=1.2)+
scale_color_brewer(name="No. Patches\n in Colony",palette = "Set1")+
ylab("Monthly Percentage Growth (%)")+
scale_x_log10()+
#scale_y_continuous(breaks=-3:3,labels=c(.001,.01,.1,1,10,100,1000))+
#scale_y_continuous(limits=c(0,10))+
#geom_abline()+
geom_hline(yintercept = 0)+
# facet_wrap("NfragBin
theme_bw()
#Which file is the colonylevel dataframe being referenced?
ColonyLevel <- read.csv("./CSV files/ColonyLevel/ASRAMP23_VitalRates_colonylevel_CLEAN.csv")
ColonyLevel %>%
filter(TransitionTypeSimple %in% c("GROWTH")) %>%
filter(Genus_Code=="POSP"&REGION=="MHI") %>%
ggplot(aes(x=StartingSummedPatchDiam,
y=100*(MonthlyPropRate_E-1),color=NfragBin))+#y=log10(TransitionRate_L)
geom_point(alpha=.1)+
stat_smooth(method="loess",span=1.2)+
scale_color_brewer(name="No. Patches\n in Colony",palette = "Set1")+
ylab("Monthly Percentage Growth (%)")+
scale_x_log10()+
#scale_y_continuous(breaks=-3:3,labels=c(.001,.01,.1,1,10,100,1000))+
#scale_y_continuous(limits=c(0,10))+
#geom_abline()+
geom_hline(yintercept = 0)+
# facet_wrap("NfragBin")+
theme_bw()
raw <- read.csv("./CSV files/RawData/HARAMP24_VitalRates_12-02-2025.csv")
# raw <- read.csv("./CSV files/RawData/MARAMP22_VitalRates_06-24-2024.csv")
ll <- read.csv("./CSV files/MetaData/VitalRates_LatLong.csv")
effort <- read.csv("./CSV files/MetaData/VitalRates_SurveyEffort.csv")
raw <- raw %>% select(-TL_SurfA)
library(dplyr)
library(anytime)
library(ggplot2)
library(ggmap)
library(viridis)
library(ggspatial)
library(ggrepel)
library(stringr)
library(sp)
#raw <- raw %>% select(-c(OID_, TL_SurfA))
raw <- raw %>% select(-TL_SurfA)
# Change some column names
raw <- raw %>% rename("Surface_Area" = "SArea")
## Look for potential issues in the data:
lapply(raw, unique)
# ## Remove or alter rows based on TL_Note:
# raw <- raw %>% filter(TL_Note != "Out of bounds in 2022") # remove colonies that could not be tracked into 2022
#
#
# ## QC Morph code:
# a <- raw[raw$Morph_Code != "MD" & raw$Morph_Code != "EM" & raw$Morph_Code != "BR" & raw$Morph_Code != "TB"
#         & raw$Morph_Code != "PL" & raw$Morph_Code != "KN",]
#
raw <- raw %>% mutate(Morph_Code = case_when(Morph_Code == "RM" ~ "EM",
Morph_Code == "EM" ~ "EM",
Morph_Code == "TB" ~ "TB",
Morph_Code == "BR" ~ "BR",
Morph_Code == "KN" ~ "KN",
Morph_Code == "PL" ~ "PL",
Morph_Code == "MD" ~ "MD"))
raw <- raw %>% mutate(Annotator = case_when (Annotator == "SJD" ~ "SD",
Annotator == "SD" ~ "SD",
Annotator == "CA" ~ "CA",
Annotator == "ES" ~ "ES",
Annotator == "KT" ~ "KT",
Annotator == "MSL" ~ "ML"))
raw$TL_Date <- anydate(raw$TL_Date) # Change date format
raw$TL_id <- str_pad(raw$TL_id, 3, pad = "0")
raw$TL_Genet <- str_pad(raw$TL_Genet, 3, pad = "0")
vr <- raw
# Turn TimePt into Year
vr$Year <- str_sub(vr$TL_Date,1,4)
vr %>% group_by(Site, TL_Date, Year) %>% summarise() # QC check
## Create unique name for all genets:
vr$Genet_full <- paste(vr$Site,  vr$TL_Genet, vr$Year, sep = "_")
vr[11,] # double check
## Create unique name for all patches:
vr$Patch_full <- paste(vr$Site, vr$TL_id, vr$Year,  sep = "_")
vr[11,] # double check
## Roll TL_Class up to genus (consider separating PGRA)
vr <- vr %>% mutate(Genus = case_when(TL_Class == "PMEA" ~ "POCS",
TL_Class == "PVER" ~ "POCS",
TL_Class == "AGLO" ~ "ACSP",
TL_Class == "PGRA" ~ "POCS",
TL_Class == "PLOB" ~ "POSP",
TL_Class == "PLIC" ~ "POSP",
TL_Class == "PLUT" ~ "POSP",
TL_Class == "POCS" ~ "POCS",
TL_Class == "MOSP" ~ "MOSP",
TL_Class == "MPAT" ~ "MOSP",
TL_Class == "MCAP" ~ "MOSP",
TL_Class == "ACSP" ~ "ACSP",
TL_Class == "POSP" ~ "POSP"))
lapply(vr, unique) # double check
View(vr)
a <- left_join(vr, effort)
effort <- read.csv("./CSV files/MetaData/VitalRates_SurveyEffort.csv")
a <- left_join(vr, effort)
## Add m2 surveyed (collected from tracking spreadsheet)
vr$Year <- as.integer(vr$Year)
a <- left_join(vr, effort)
?left_join
a <- left_join(vr, effort, by = c(Site, Year))
View(vr)
a <- left_join(vr, effort, by = c("Site", "Year"))
head(a)
vr$area_perim <- vr$Shape_Area/vr$Shape_Leng
head(vr)
vr_col <- vr %>% dplyr::select(Genet_full, TL_Area, TL_Perim, Shape_Leng, Shape_Area, Surface_Area, area_perim)
vr_meta <- vr %>% dplyr::select(Genet_full, Island, Region, Site, TimePt, Year, TL_Date, Latitude,Longitude,
Genus, TL_Class, TL_Genet, Quadrat, Effort) %>%
distinct()
## Add island code
vr$Island_Code <- str_sub(vr$Site,5,7)
## Add island code
vr$Island <- str_sub(vr$Site,5,7)
# Create colony dataframe:
vr_col <- vr %>% dplyr::select(Genet_full, TL_Area, TL_Perim, Shape_Leng, Shape_Area, Surface_Area, area_perim)
vr_meta <- vr %>% dplyr::select(Genet_full, Island, Region, Site, TimePt, Year, TL_Date, Latitude,Longitude,
Genus, TL_Class, TL_Genet, Quadrat, Effort) %>%
distinct()
vr_meta <- vr %>% dplyr::select(Genet_full, Island, Site, TimePt, Year, TL_Date, Latitude,Longitude, #Region,
Genus, TL_Class, TL_Genet, Quadrat, Effort) %>%
distinct()
vr_meta <- vr %>% dplyr::select(Genet_full, Island, Site, TimePt, Year, TL_Date, #Latitude,Longitude, Region,
Genus, TL_Class, TL_Genet, Quadrat, Effort) %>%
distinct()
ll <- ll %>% filter(Region != "vr") %>% rename(Site = ESD.Site.Name) %>% select(-Year)
vr <- left_join(vr, ll)
vr_meta <- vr %>% dplyr::select(Genet_full, Island, Site, TimePt, Year, TL_Date, Latitude,Longitude, #Region, Effort
Genus, TL_Class, TL_Genet, Quadrat) %>%
distinct()
vr_col <- aggregate(.~Genet_full, data = vr_col, sum)
vr_col <- left_join(vr_meta,vr_col)
# Total genets per Site-Year (ONLY colonies that survived 2+ time points):
vr_col$Site_Genet <- paste(vr_col$Site,vr_col$TL_Genet,  sep = "_") # use this column to filter
# Add column for number of patches
a <- vr %>% group_by(Site, Year,TL_Genet) %>% summarise(nPatches = n())
View(a)
vr_col <- left_join(vr_col, a)
#### Format dataframe into archive csv file ####
# Add in Island_Code, DataorError, Error_Category
archive <- vr_col
head(vr_col)
## Add Lat and Long
ll <- ll %>% filter(Region != "vr") %>% rename(Site = ESD.Site.Name) %>% select(-Year)
head(ll)
# raw <- read.csv("./CSV files/RawData/MARAMP22_VitalRates_06-24-2024.csv")
ll <- read.csv("./CSV files/MetaData/VitalRates_LatLong.csv")
effort <- read.csv("./CSV files/MetaData/VitalRates_SurveyEffort.csv")
View(effort)
raw <- read.csv("./CSV files/RawData/HARAMP24_VitalRates_12-02-2025.csv")
raw <- raw %>% rename("Surface_Area" = "SArea")
#
raw <- raw %>% mutate(Morph_Code = case_when(Morph_Code == "RM" ~ "EM",
Morph_Code == "EM" ~ "EM",
Morph_Code == "TB" ~ "TB",
Morph_Code == "BR" ~ "BR",
Morph_Code == "KN" ~ "KN",
Morph_Code == "PL" ~ "PL",
Morph_Code == "MD" ~ "MD"))
raw <- raw %>% mutate(Annotator = case_when (Annotator == "SJD" ~ "SD",
Annotator == "SD" ~ "SD",
Annotator == "CA" ~ "CA",
Annotator == "ES" ~ "ES",
Annotator == "KT" ~ "KT",
Annotator == "MSL" ~ "ML"))
raw$TL_Date <- anydate(raw$TL_Date) # Change date format
raw$TL_id <- str_pad(raw$TL_id, 3, pad = "0")
raw$TL_Genet <- str_pad(raw$TL_Genet, 3, pad = "0")
vr <- raw
# Turn TimePt into Year
vr$Year <- str_sub(vr$TL_Date,1,4)
vr %>% group_by(Site, TL_Date, Year) %>% summarise() # QC check
## Create unique name for all genets:
vr$Genet_full <- paste(vr$Site,  vr$TL_Genet, vr$Year, sep = "_")
vr[11,] # double check
## Create unique name for all patches:
vr$Patch_full <- paste(vr$Site, vr$TL_id, vr$Year,  sep = "_")
vr[11,] # double check
## Roll TL_Class up to genus (consider separating PGRA)
vr <- vr %>% mutate(Genus = case_when(TL_Class == "PMEA" ~ "POCS",
TL_Class == "PVER" ~ "POCS",
TL_Class == "AGLO" ~ "ACSP",
TL_Class == "PGRA" ~ "POCS",
TL_Class == "PLOB" ~ "POSP",
TL_Class == "PLIC" ~ "POSP",
TL_Class == "PLUT" ~ "POSP",
TL_Class == "POCS" ~ "POCS",
TL_Class == "MOSP" ~ "MOSP",
TL_Class == "MPAT" ~ "MOSP",
TL_Class == "MCAP" ~ "MOSP",
TL_Class == "ACSP" ~ "ACSP",
TL_Class == "POSP" ~ "POSP"))
lapply(vr, unique) # double check
## Add island code
vr$Island <- str_sub(vr$Site,5,7)
## Add Lat and Long
ll <- ll %>% filter(Region != "vr") %>% rename(Site = ESD.Site.Name) %>% select(-Year)
vr <- left_join(vr, ll)
## Add m2 surveyed (collected from tracking spreadsheet)
vr$Year <- as.integer(vr$Year)
a <- left_join(vr, effort, by = c("Site", "Year"))
View(effort)
raw <- read.csv("./CSV files/RawData/HARAMP24_VitalRates_12-02-2025.csv")
# raw <- read.csv("./CSV files/RawData/MARAMP22_VitalRates_06-24-2024.csv")
ll <- read.csv("./CSV files/MetaData/VitalRates_LatLong.csv")
effort <- read.csv("./CSV files/MetaData/VitalRates_SurveyEffort.csv")
#### QC Data ####
## (OPTIONAL) Remove superfluous columns:
colnames(raw)
#raw <- raw %>% select(-c(OID_, TL_SurfA))
raw <- raw %>% select(-TL_SurfA)
# Change some column names
raw <- raw %>% rename("Surface_Area" = "SArea")
## Look for potential issues in the data:
lapply(raw, unique)
# ## Remove or alter rows based on TL_Note:
# raw <- raw %>% filter(TL_Note != "Out of bounds in 2022") # remove colonies that could not be tracked into 2022
#
#
# ## QC Morph code:
# a <- raw[raw$Morph_Code != "MD" & raw$Morph_Code != "EM" & raw$Morph_Code != "BR" & raw$Morph_Code != "TB"
#         & raw$Morph_Code != "PL" & raw$Morph_Code != "KN",]
#
raw <- raw %>% mutate(Morph_Code = case_when(Morph_Code == "RM" ~ "EM",
Morph_Code == "EM" ~ "EM",
Morph_Code == "TB" ~ "TB",
Morph_Code == "BR" ~ "BR",
Morph_Code == "KN" ~ "KN",
Morph_Code == "PL" ~ "PL",
Morph_Code == "MD" ~ "MD"))
raw <- raw %>% mutate(Annotator = case_when (Annotator == "SJD" ~ "SD",
Annotator == "SD" ~ "SD",
Annotator == "CA" ~ "CA",
Annotator == "ES" ~ "ES",
Annotator == "KT" ~ "KT",
Annotator == "MSL" ~ "ML"))
## Check if TimePt is labelled correctly:
a <- raw %>% group_by(Site, TL_Date, TimePt) %>% summarise(sum(TimePt)) ; View(a)
# HOW-005-2017/2018 = Jan 1
# TUT-019-2018 = Jan 1
# raw$TL_Date <- as.factor(raw$TL_Date)
# raw <- raw %>% mutate(TL_Date = recode(TL_Date,"1/1/2017" = "5/3/2017"))
# raw$TL_Date <- raw$TL_Date[raw$Site == "OCC-HOW-005" & raw$TL_Date == "1/1/2018"] = "6/8/2018"
# raw$TL_Date <- raw$TL_Date[which(raw$Site == "OCC-TUT-017" & raw$TL_Date == "1/1/2018")] <- "7/6/2018"
raw$TL_Date <- anydate(raw$TL_Date) # Change date format
# Add leading zeros to genet and colony code
raw$TL_id <- str_pad(raw$TL_id, 3, pad = "0")
raw$TL_Genet <- str_pad(raw$TL_Genet, 3, pad = "0")
#### Create additional columns #####
vr <- raw
# Turn TimePt into Year
vr$Year <- str_sub(vr$TL_Date,1,4)
vr %>% group_by(Site, TL_Date, Year) %>% summarise() # QC check
## Create unique name for all genets:
vr$Genet_full <- paste(vr$Site,  vr$TL_Genet, vr$Year, sep = "_")
vr[11,] # double check
## Create unique name for all patches:
vr$Patch_full <- paste(vr$Site, vr$TL_id, vr$Year,  sep = "_")
vr[11,] # double check
## Roll TL_Class up to genus (consider separating PGRA)
vr <- vr %>% mutate(Genus = case_when(TL_Class == "PMEA" ~ "POCS",
TL_Class == "PVER" ~ "POCS",
TL_Class == "AGLO" ~ "ACSP",
TL_Class == "PGRA" ~ "POCS",
TL_Class == "PLOB" ~ "POSP",
TL_Class == "PLIC" ~ "POSP",
TL_Class == "PLUT" ~ "POSP",
TL_Class == "POCS" ~ "POCS",
TL_Class == "MOSP" ~ "MOSP",
TL_Class == "MPAT" ~ "MOSP",
TL_Class == "MCAP" ~ "MOSP",
TL_Class == "ACSP" ~ "ACSP",
TL_Class == "POSP" ~ "POSP"))
lapply(vr, unique) # double check
## Add island code
vr$Island <- str_sub(vr$Site,5,7)
## Add Lat and Long
ll <- ll %>% filter(Region != "vr") %>% rename(Site = ESD.Site.Name) %>% select(-Year)
vr <- left_join(vr, ll)
## Add m2 surveyed (collected from tracking spreadsheet)
vr$Year <- as.integer(vr$Year)
a <- left_join(vr, effort, by = c("Site", "Year","Genus"))
View(ll)
View(a)
is.factor(vr$Island)
is.factor(effort$Island)
str(vr)
str(effort)
View(vr)
## Add m2 surveyed (collected from tracking spreadsheet)
vr$Year <- as.integer(vr$Year)
a <- left_join(vr, effort, by = c("Site", "Year","Genus"))
vr$area_perim <- vr$Shape_Area/vr$Shape_Leng
vr_col <- vr %>% dplyr::select(Genet_full, TL_Area, TL_Perim, Shape_Leng, Shape_Area, Surface_Area, area_perim)
vr_meta <- vr %>% dplyr::select(Genet_full, Island, Site, TimePt, Year, TL_Date, Latitude,Longitude, #Region, Effort
Genus, TL_Class, TL_Genet, Quadrat) %>%
distinct()
vr_col <- aggregate(.~Genet_full, data = vr_col, sum)
vr_col <- left_join(vr_meta,vr_col)
# Total genets per Site-Year (ONLY colonies that survived 2+ time points):
vr_col$Site_Genet <- paste(vr_col$Site,vr_col$TL_Genet,  sep = "_") # use this column to filter
# Add column for number of patches
a <- vr %>% group_by(Site, Year,TL_Genet) %>% summarise(nPatches = n())
vr_col <- left_join(vr_col, a)
#setwd('C:/Users/Corinne.Amir/Documents/GitHub/PIFSC_VitalRates/CSV files')
write.csv(vr,"./CSV files/PatchLevel/HARAMP22_VitalRates_patchlevel_CLEAN.csv",row.names = F)
write.csv(vr_col,"./CSV files/ColonyLevel/HARAMP22_VitalRates_colonylevel_CLEAN.csv",row.names = F)
