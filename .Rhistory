#Add NCRMP region-year mean
regyrSum=Jsec_P_ALL %>%
group_by(REGION,ANALYSIS_YEAR,Genus) %>%
filter(!is.nan(MN.RecVal)) %>%
summarize(MN.REGYR.RecVal=mean(MN.RecVal,na.rm=T),
SE.REGYR.RecVal=sqrt(sum(SE.RecVal^2,na.rm=T))) %>%
mutate(REGION=ifelse(REGION=="PRIAs",
"PRIA",
ifelse(REGION%in%c("GUA","CNMI"),
"MARIAN",
REGION)))
RecComp=RecComp %>% left_join(regyrSum,by=join_by(REGION,ANALYSIS_YEAR,Genus))
RecComp[1,]
regyrSum
############################################################################
#Compile All Available RecVal estimates for each VRSector
#Start with all ColTrans SIGs
metacol=c("REGION","Island","SEC_NAME","SIG","Site","Interval","Genus","Interval_Years")
SIGcol=c("Site","Interval","Genus")
RecComp=unique(ColTrans[,c(metacol)])
RecComp=RecComp %>% rename(ISLANDCODE=Island)
RecComp$ISLAND=SecIslLU[RecComp$SEC_NAME]
SFMRecValcol=c("RecSFM_p_SiteAdcm2_Yr")
#Got to push SFM obs into next interval for recruitment values
MergeSFM=RecSFMDataFrame[,c(metacol,SFMRecValcol)]
MergeSFM=MergeSFM %>% rename(DataInterval=Interval)
for (i in 1:nrow(MergeSFM)){
thissite=MergeSFM %>% filter(Site==MergeSFM$Site[i])
uI=sort(unique(thissite$DataInterval))
MergeSFM$RecInterval[i]=uI[which(MergeSFM$DataInterval[i]==uI)+1]
}
MergeSFM=MergeSFM %>% rename(Interval=RecInterval) %>% dplyr::select(-DataInterval)
#Add SFM rec to proper Interval
RecComp=RecComp %>% left_join(MergeSFM[c(SIGcol,SFMRecValcol)]) %>%
rename(SFMObs.SiteYrRecVal=RecSFM_p_SiteAdcm2_Yr)
#Add NCRMP RecVal at sector scale
RecComp$ANALYSIS_YEAR=(paste0("20",substr(RecComp$Interval,1,2)))
recvalcol=c("MN.RecVal","SE.RecVal","N.RecVal","CI95.RecVal","LOW_CI95.RecVal","HIGH_CI95.RecVal")
RecComp = RecComp %>% left_join(Jsec_P_Asec[,c("ANALYSIS_SEC","ANALYSIS_YEAR","Genus",recvalcol)],
by=join_by(SEC_NAME==ANALYSIS_SEC,ANALYSIS_YEAR,Genus))
names(RecComp)=gsub(names(RecComp),pattern = "\\.RecVal",replacement = "\\.SecYrRecVal")
#Add NCRMP Mean Sector-Level across years
SecSum=Jsec_P_ALL %>% group_by(REGION,ISLAND,ANALYSIS_SEC,Genus) %>%
summarize(MN.SecSumRecVal=mean(MN.RecVal,na.rm=T),
SE.SecSumRecVal=sqrt(sum(SE.RecVal^2,na.rm=T))) %>% ungroup() %>%
dplyr::select(-REGION,-ISLAND)
RecComp=RecComp %>% left_join(SecSum,by=join_by(SEC_NAME==ANALYSIS_SEC,Genus))
#Add NCRMP island-year mean
islyrSum=Jsec_P_ALL %>%
group_by(REGION,ISLAND,ANALYSIS_YEAR,Genus) %>%
filter(!is.nan(MN.RecVal)) %>%
summarize(MN.ISLYR.RecVal=mean(MN.RecVal,na.rm=T),
SE.ISLYR.RecVal=sqrt(sum(SE.RecVal^2,na.rm=T))) %>%
ungroup() %>%
dplyr::select(-REGION)
RecComp=RecComp %>% left_join(islyrSum,by=join_by(ISLAND,ANALYSIS_YEAR,Genus))
#Add NCRMP region-year mean
regyrSum=Jsec_P_ALL %>%
mutate(REGION=ifelse(REGION=="PRIAs",
"PRIA",
ifelse(REGION%in%c("GUA","CNMI"),
"MARIAN",
REGION))) %>%
group_by(REGION,ANALYSIS_YEAR,Genus) %>%
filter(!is.nan(MN.RecVal)) %>%
summarize(MN.REGYR.RecVal=mean(MN.RecVal,na.rm=T),
SE.REGYR.RecVal=sqrt(sum(SE.RecVal^2,na.rm=T)))
RecComp=RecComp %>% left_join(regyrSum,by=join_by(REGION,ANALYSIS_YEAR,Genus))
write.csv(RecComp,file = "./Data/RecruitmentData/VRSite_RecruitmentMetricComparison_2026.csv")
rm(list=ls())
# Loading Libraries -------------------------------------------------------
library(tidyverse)
library(lubridate)
library(stringr)
library(pROC)
library(ggpubr)
library(sf)
library(patchwork)
# Loading Functions -------------------------------------------------------
leadz=function(x,n){return(formatC(x,width=n,flag=0))}
A2D=function(A){return(2*sqrt(A/pi))}
D2A=function(D){return((D/2)^2*pi)}
m22cm2=function(x){return(x*10^4)}
#source("R/gcdist.R") # No such file or directory
# Loading / Managing DataFrames: ColTrans, surv_dat  ----------------------------------------------  ---------
ColTrans=read.csv("./Data/ColonyTransitions/MAASHA_22-24_AllColonyTransitions.csv")
ColTrans=ColTrans %>%
rename(StartingDate=TL_Date_STA,EndingDate=TL_Date_END) %>%
mutate(SiteInterval=paste0(Site,"_",Interval))
#Prepping surv_dat output
surv_dat=ColTrans[,c("Site","Site_Genet","Genus","Interval","SiteInterval","l10_Area_STA","nPatches_STA","Survival","TransitionTypeSimple","Interval_Years","StartingDate","EndingDate")]
# ^ missing SiteInterval, N_t0, TransitionType, StartingDate","EndingDate. Needs to b3 added in code #2
# Is this located in the packages code?
surv_dat=subset(surv_dat,TransitionTypeSimple!="RECR")
surv_dat=surv_dat %>% rename(ColonyID=Site_Genet,size=l10_Area_STA,survival=Survival,Genus=Genus,
N_t0=nPatches_STA,TransitionType=TransitionTypeSimple)
#names(surv_dat)=c("ColonyID","size","survival","Genus","Interval","SiteInterval","Site","N_t0","TransitionType","Interval_Years")
# Change these file names when saving data to refect the new changes
save(ColTrans, file="data/Colony_Data_20251216_edited.rdata")
save(surv_dat, file="data/Colony_Data_20251216_edited_survival.rdata")
# Where we run the models -------------------------------------------------
#Define Site - Interval - Taxa groupings for which to run models
#SiteIntervalGenus
ColTrans$SIG=paste0(substr(ColTrans$Site,5,7),substr(ColTrans$Site,9,11),"_",
substr(year(ColTrans$StartingDate),3,4),leadz(month(ColTrans$StartingDate),2),"-",
substr(year(ColTrans$EndingDate),3,4),leadz(month(ColTrans$EndingDate),2),"_",
ColTrans$Genus)
#Not pursuing species level data
# #SiteIntervalSpecies
# ColTrans$SIS=paste0(substr(ColTrans$Site,5,7),substr(ColTrans$Site,9,11),"_",
#                        substr(year(ColTrans$StartingDate),3,4),leadz(month(ColTrans$StartingDate),2),"-",
#                        substr(year(ColTrans$EndingDate),3,4),leadz(month(ColTrans$EndingDate),2),"_",
#                        ColTrans$)
#Report on Grouping
Usig=unique(ColTrans$SIG);
#Usis=unique(ColTrans$SIS)
Nsig=length(Usig);Nsig
#Nsis=length(Usis);Nsis
Name="2025_VR_Models_"
# Load Data to Get Proportion of "True" Recruitment ------------------------------------
#Assign SFM Sites to Sectors
#CSV file not in github
sitemd=read.csv("./Data/MetaData/VitalRates_LatLong.csv");
setdiff(ColTrans$Site,sitemd$ESD.Site.Name)#LL for each sampled site
setdiff(sitemd$ESD.Site.Name,ColTrans$Site)#But Metadata for one site with no associated data
names(sitemd)[4]="Site";
sitemd <- distinct(sitemd)
#sitemd=sitemd %>% group_by(Site) %>% summarize(Lat=mean(Latitude),Lon=mean(Longitude))
uSD=ColTrans[,c("Site","StartingDate","EndingDate")] %>%
pivot_longer(cols=c("StartingDate","EndingDate"),values_to="Date") %>%
dplyr::select(all_of(c("Site","Date"))) %>%
unique()
CL.sf=as.data.frame(left_join(uSD,sitemd[,c("Site","Latitude","Longitude")],by=c("Site"))) #Site,Date,Lat,Long dataframe
CL.sf=st_as_sf(na.omit(CL.sf),coords=c("Longitude","Latitude")) #create geometry column
secshp= st_read(dsn = "./Data/Shapefiles/",layer = "ALLPacific_Sectors_Islands_5km_buffer")
if(!all(st_is_valid(secshp))){secshp=st_make_valid(secshp)}
st_is_valid(secshp)[-26]
CL.sf = CL.sf %>% st_set_crs(value = st_crs(secshp[-26])) #retrieve coordinate system
Site2Sec=st_join(CL.sf,secshp[-26,"SEC_NAME"])
na_i=which(is.na(Site2Sec$SEC_NAME))
Site2Sec$SEC_NAME[na_i]="French Frigate"
#Add Sect#Add Sector to ColTrans dataframe!
Site2Sec_ONLY=unique(st_drop_geometry(Site2Sec)[,c("Site","SEC_NAME")])
#Fixed#Site2Sec_ONLY$SEC_NAME[Site2Sec_ONLY$Site=="FFS_OCC_002"]="French Frigate"
#Dropped#Site2Sec_ONLY$SEC_NAME[Site2Sec_ONLY$Site=="FFS_OCC_014"]="French Frigate"
#Fixed#Site2Sec_ONLY$SEC_NAME[Site2Sec_ONLY$Site=="HAW_OCC_003"]="HAW_PUNA"
#Dropped#Site2Sec_ONLY$SEC_NAME[Site2Sec_ONLY$Site=="HAW_SIO_K08"]="HAW_KONA"
ColTrans=ColTrans %>% left_join(Site2Sec_ONLY[,c("Site","SEC_NAME")],by="Site")
ColTrans$Shape_Area_STA_cm2=m22cm2(ColTrans$Shape_Area_STA)
ColTrans$Shape_Area_END_cm2=m22cm2(ColTrans$Shape_Area_END)
save(ColTrans, file="data/Colony_Data_20251216_edited.rdata")
#Get observed proportion of 'juveniles' as true recruits (SfM data)
#gray=juveniles, blue=true recruits
RECs=subset(ColTrans,TransitionTypeSimple=="RECR")
bw=0.5
ggplot()+
geom_histogram(data=subset(ColTrans,m22cm2(Shape_Area_END) >0),aes(A2D(m22cm2(Shape_Area_END) )),fill="grey",binwidth=bw)+
xlim(c(0,10))+
geom_histogram(data=RECs,aes(A2D(m22cm2(Shape_Area_END) )),fill="blue",binwidth=bw)+
facet_grid(Genus~.,scales = "free_y")+
geom_vline(xintercept = 5)+
theme_bw()+
ggtitle("Proportion of juveniles compared to true recruits")+
labs(x="Diameter (cm)",color = "Legend")
#Check Proportion of Recruits per Taxon - hist calculation
binwidths=bw#c(.1,.25,.5,1)
uG=c("SSSS","POCS","POSP","MOSP","ACSP")
PropRec_g=cbind(expand.grid(Genus=uG,BinWidth=binwidths),PropRec=NA)
for(i_b in 1:length(binwidths)){
binwidth=binwidths[i_b]
N=5/binwidth
for(i_G in 1:length(uG)){
if(uG[i_G]=="SSSS"){
hcl=hist(A2D(subset(ColTrans,Shape_Area_END_cm2>0)$Shape_Area_END_cm2),breaks=seq(0,1000,by=binwidth),plot = F)
hrc=hist(A2D(RECs$Shape_Area_END_cm2),breaks=seq(0,1000,by=binwidth),plot = F)
PropRec_v=(hrc$counts[1:(N+1)]/hcl$counts[1:(N+1)])
out_i=which(PropRec_g$Genus==uG[i_G]&PropRec_g$BinWidth==binwidth)
PropRec_g$PropRec[out_i]=mean(PropRec_v[1:(N+1)],na.rm=T)
}else{
hcl=hist(A2D(subset(ColTrans,Shape_Area_END_cm2>0&Genus==uG[i_G])$Shape_Area_END_cm2),breaks=seq(0,1000,by=binwidth),plot = F)
hrc=hist(A2D(subset(RECs,Genus==uG[i_G])$Shape_Area_END_cm2),breaks=seq(0,1000,by=binwidth),plot = F)
PropRec_v=(hrc$counts[1:(N+1)]/hcl$counts[1:(N+1)])
out_i=which(PropRec_g$Genus==uG[i_G]&PropRec_g$BinWidth==binwidth)
PropRec_g$PropRec[out_i]=mean(PropRec_v[1:(N+1)],na.rm=T)
# plot(hcl$breaks[1:(N+1)],PropRec_v,type="b",ylim=c(0,1),main=uG[i_G])
# abline(h=mean(propREC,na.rm=T))}
}
}
}
PropRec_g
#detach(package:plyr)
PropRecMn=PropRec_g %>%
group_by(Genus) %>%
summarise(meanPropRec=mean(PropRec))
#Final 0-5 cm diam. Proportion Recruits in the Juvenile size classes (will use for 'pro-rating')
PropRecMn
################################################################################
######### Site + Interval Years + Genus models #################################
########## Recruitment ! #######################################################
################################################################################
####Case 1 Assume Site - Level Stock Recruitment Relationship
####### Unlikely to hold true, but might be a decent approximation in skewed dispersal kernels
#recval is N recruits per Area of adult biomass - N/cm^2
# EQN 1: Then recval = ((Observed recruits-N)/ (Area Surveyed-cm^2)) / (Adult Area-cm^2)/Area Surveyed-cm^2)
# Adult area could come from site-level percent cover*area surveyed; or measured SFM adult area / Area surveyed
####Case 2 Assume Sector - Level Stock Recruitment Relationship
#recval is N recruits per Area of adult biomass - N/cm^2
# EQN 2: Then sector SFM recval = (SFM Observed recruits-N)/ Area Surveyed-cm^2) / (sector-level proportional cover) ###?
# EQN 3: Or sector REA recval = (REA Observed recruits***-N)/ Area Surveyed-cm^2) / (sector-level proportional cover)
# *** here we should prorate our REA juv density by SFM calibrated prop. of recruits in juv size classes
################################################################################
#SFM Observed Recruitment Rates
################################################################################
#Case 1: Assume Site-Level Stock-Recruitment
#Area Surveyed for each SIG
Asurv=read.csv("./Data/MetaData/VitalRates_SurveyEffort_TAOedit_20260105.csv")
Asurv=Asurv %>% rename(Effort_m2=Effort,Year_END=Year) %>%
mutate(Effort_cm2=m22cm2(Effort_m2))
#Filter out any weird Asurv data by matching back to ColTrans
matchcol=c("Island","Site","Genus","Year_END","SIG","Interval")
uMC=ColTrans[,matchcol] %>% distinct()
uMC %>% filter(Site=="OCC-ASC-003")
Asurv=Asurv %>% left_join(uMC) %>% filter(!is.na(SIG))
#many-to-many makes sense for the two cases...
Asurv[which(is.na(Asurv$SIG)),]
#,SIG=paste0(substr(SITE,5,7),substr(SITE,9,11),"-",)
#Area of Adult Colonies for each SIG
Atax=ColTrans %>%
group_by(SIG,Site,Interval,Genus,StartingDate,EndingDate,Interval_Years) %>%
summarise(AdultCoralArea_cm2=sum(Shape_Area_STA_cm2)) #Area of adult cm2 = sum all corals in each genus for each year
#Link to Nrecruits from the StartingSize summed area: Adults at beginning of interval generate
names(Atax)
names(Atax)
RecSFMTib=ColTrans %>%
filter(TransitionTypeSimple %in% c("RECR")) %>%
group_by(SEC_NAME,SIG,Site,Interval,Genus,REGION,StartingDate,EndingDate,Interval_Years) %>%
summarize(Nrec=length(which(TransitionTypeSimple=="RECR"))) %>%
left_join(Atax) %>%
left_join(Asurv) %>%
mutate(
# numb recruits/area surveyed cm2
RecSFM_p_Survcm2=Nrec/Effort_cm2,
#Case 1: Assume Site-Level Stock-Recruitment
#Recruit N per adult area and annual rate
RecSFM_p_SiteAdcm2=Nrec/AdultCoralArea_cm2,
RecSFM_p_SiteAdcm2_Yr=RecSFM_p_SiteAdcm2/Interval_Years) # numb recruits/total adult area cm2 annualized
RecSFMDataFrame=as.data.frame(RecSFMTib)
write.csv(RecSFMDataFrame,file = "./Data/RecruitmentData/RecVal_SFMObservation_VRSector.csv")
#save(RecSFMDataFrame, file = paste0("data/",Name,"_RecSFMrates.rdata"))
#plot
hist(RecSFMDataFrame$RecSFM_p_SiteAdcm2_Yr, breaks = 20)
#REGIONAL CALCULATIONS BY GENUS AND REGION
RecSFMDataFrame$RecSFM_p_SiteAdcm2_Yr[RecSFMDataFrame$RecSFM_p_SiteAdcm2_Yr == Inf] <-NA
#Calculate median, mean, and lower/upper quantiles for site-level stock recruitment GENUS values
RecSFMSummary=RecSFMDataFrame %>%
dplyr::select(SEC_NAME,Site,Interval,Genus,REGION,RecSFM_p_SiteAdcm2_Yr)%>%
group_by(Genus,REGION)%>%
summarise(SiteStock_median = median(RecSFM_p_SiteAdcm2_Yr, na.rm = TRUE),
SiteStock_mean = mean(RecSFM_p_SiteAdcm2_Yr, na.rm = TRUE),
SiteStock_q05= quantile(RecSFM_p_SiteAdcm2_Yr, c(0.05),na.rm = TRUE),
SiteStock_q95= quantile(RecSFM_p_SiteAdcm2_Yr, c(0.95),na.rm = TRUE)
)
write.csv(RecSFMSummary,file = "./Data/RecruitmentData/RecVal_SFMObservation_GENUS.REGION.csv")
#REA Observed Recruitment Rates per adult cover, at Sector and Site Level,
#with SIG matching site-level data grouped at sector containing SIG
#Case 2: Assume Sector-Level Stock-Recruitment
#Site Recruitment, Sector Stock
#Get Site-Level and Sector_level REA juv density
rea_sec=read.csv("T:/Benthic/Data/REA Coral Demography & Cover/Summary Data/Sector/BenthicREA_SECTOR_GENUS_CODE_COMPLETE_2013_2024.csv")
rea_sec=rea_sec %>% rename(ANALYSIS_SEC=PooledSector_Viztool,Genus=GENUS_CODE)
#Get Percent Cover by Genus at each Sector
cov1_sec=read.csv("T:/Benthic/Data/REA Coral Demography & Cover/Summary Data/Sector/BenthicCover_2010-2024_Tier1_SECTOR_Complete.csv")
cov3_sec=read.csv("T:/Benthic/Data/REA Coral Demography & Cover/Summary Data/Sector/BenthicCover_2010-2024_Tier3_SECTOR_Complete.csv")
uSec=na.omit(unique(ColTrans$SEC_NAME))
uSecIsl=unique(cov1_sec[,c("ISLAND","ANALYSIS_SEC")])
SecIslLU=uSecIsl$ISLAND;names(SecIslLU)=uSecIsl$ANALYSIS_SEC
SAGadd=c("Alamagan","Guguan","Sarigan");names(SAGadd)=c("Alamagan","Guguan","Sarigan")
AddSec=c("Guam","Guam","Rose","Tau","Tau","Tutuila")
names(AddSec)=c("GUA_TUMON_BAY","GUA_PITI_BOMB","ROS_SANCTUARY","TAU_OPEN","TAU_SANCTUARY","TUT_FAGATELE")
SecIslLU=c(SecIslLU,SAGadd,AddSec)
rea_sec$ISLAND=SecIslLU[rea_sec$ANALYSIS_SEC]
# table(rea_sec$ISLAND,useNA = "always")
# rea_sec[which(is.na(rea_sec$ISLAND)),c("ISLAND","ANALYSIS_SEC")]
#Trim "Mean."
names(cov1_sec)=gsub(pattern = "Mean.",replacement = "",names(cov1_sec))
#names(cov1_sec)[6:14]=substr(names(cov1_sec)[6:14],6,999)
meta=cov1_sec %>% dplyr::select(REGION:N) %>% names()
classes1=cov1_sec %>% dplyr::select(CORAL:HALI) %>% names()
SEclasses1=cov1_sec %>% dplyr::select(SE.CORAL:SE.HALI) %>% names()
names(cov3_sec)=gsub(pattern = "Mean.",replacement = "",names(cov3_sec))
#names(cov3_sec)[6:109]=substr(names(cov3_sec)[6:109],6,999)
classes3=cov3_sec %>% dplyr::select(ENC:COTS) %>% names()
SEclasses3=cov3_sec %>% dplyr::select(SE.ENC:SE.COTS) %>% names()
#select first 15 cols of cov1_sec and pivot CORAL,MA,TURF,CCA,EMA,SC,I,SED,HAL to
#a new column titled CAT and values to column titled COVER
cov1_lse = cov1_sec[,c(meta,SEclasses1)] %>%
pivot_longer(cols = all_of(SEclasses1),names_to="CAT",values_to="SE.COVER")
cov1_lse$CAT=substr(cov1_lse$CAT,4,999) #drop 'SE.'
cov1_l = cov1_sec[,c(meta,classes1)] %>% #get cover by category & N
pivot_longer(cols = all_of(classes1),names_to="CAT",values_to="COVER") %>%
left_join(cov1_lse,by=c(meta,"CAT"))
cov1_l=cov1_l[,c("REGION","ISLAND","ANALYSIS_SEC","ANALYSIS_YEAR","CAT","COVER","SE.COVER","N")]
cov1_l$SD.COVER=cov1_l$SE.COVER*sqrt(cov1_l$N)
cov1_l$VAR.COVER=cov1_l$SD.COVER^2
cov3_lse = cov3_sec[,c(meta,SEclasses3)] %>%
pivot_longer(cols = all_of(SEclasses3),names_to="CAT",values_to="SE.COVER")
cov3_lse$CAT=substr(cov3_lse$CAT,4,999)
cov3_l = cov3_sec[,c(meta,classes3)] %>%
pivot_longer(cols = all_of(classes3),names_to="CAT",values_to="COVER") %>%
left_join(cov3_lse,by=c(meta,"CAT"))
cov3_l=cov3_l[,c("REGION","ISLAND","ANALYSIS_SEC","ANALYSIS_YEAR","CAT","COVER","SE.COVER","N")]
cov3_l$SD.COVER=cov3_l$SE.COVER*sqrt(cov3_l$N)
cov3_l$VAR.COVER=cov3_l$SD.COVER^2
MPPcovers=c("MOBR","MOEN","MONE","MOFO","POCS","POEN","POFO","POMA","PONM","POBR","ACBR","ACTA") #cover categories for each genus for Tier3 benthic cat
names(MPPcovers)=c(rep("MOSP",4),"POCS",rep("POSP",5),rep("ACSP",2))
MMPlu=names(MPPcovers)
names(MMPlu) = MPPcovers
cov_l=rbind(subset(cov1_l,CAT=="CORAL"),subset(cov3_l,CAT%in%MPPcovers))
cov_l$Genus=MMPlu[cov_l$CAT] #add Genus column
cov_l$Genus[cov_l$CAT=="CORAL"]="SSSS" #if category is coral, assign SSSS genus code
cov_l$SEC_YEAR=paste0(cov_l$ANALYSIS_SEC,"-",cov_l$ANALYSIS_YEAR)
cov_l$REGION=factor(cov_l$REGION,levels=c("MHI","NWHI","PRIAs","MARIAN","SAMOA"))
#SUM all within genus variation at each site
keepcols=c("REGION","ISLAND","ANALYSIS_SEC","ANALYSIS_YEAR","Genus","SEC_YEAR")
cov_sum=cov_l %>%  #cover by genus code and sector
group_by(ANALYSIS_SEC,ANALYSIS_YEAR,Genus) %>%
summarize(COVER=sum(COVER),VAR.COVER=sum(VAR.COVER),N.COVER=sum(N))
cov_sum$SD.COVER=sqrt(cov_sum$VAR.COVER)
cov_sum$SE.COVER=cov_sum$SD.COVER/sqrt(cov_sum$N.COVER)
cov=left_join(cov_sum,unique(cov_l[,keepcols]),by=c("ANALYSIS_SEC","ANALYSIS_YEAR","Genus")) #cov_l by distint benth cats. sum all cover by genus
cov=cov[,c(keepcols,"COVER","SE.COVER","N.COVER")] #reorganize columns
#cover is percent cover (0-100%)
# prorated mean juvenile col density for each sector and each year divided by adult cover sector year genus
#get mean, 5 and 95 quantiles for each sector year genus
#for each of those ^^ 3 numbers, want to prorate depending on genus code.
table(cov$ANALYSIS_YEAR,useNA = "always")
table(rea_sec$ANALYSIS_YEAR,useNA = "always")
names(rea_sec)[which(names(rea_sec)=="Sector")]="ANALYSIS_SEC"
names(rea_sec)[which(names(rea_sec)=="n")]="N.JCD"
#rea_sec$OBS_YEAR=rea_sec$ANALYSIS_YEAR
#cov$OBS_YEAR=cov$ANALYSIS_YEAR
# Propagating error for sector level stock recruitment
#mJCDp =  mJCD*MeanPropRec
#seJCDp = seJCD*MeanPropRec
#sdJCDp = sqrt(nJCD)*seJCDp
#nJCDp = nJCD
#sdAC = sqrt(nAC)*seAC
#mRec = mJCDp/mAC
#sdRec = mRec*sqrt((sdJCDp/mJCDp)^2 + (sdAC/mAC)^2))
#nRec = min(nJCD,nAC)????
#seRec = sdRec/sqrt(nRec)
#CI95Rec = 1.96*seRec
cov$P_COVER=cov$COVER/100 #convert percent cover to proportional cover
cov$SE.P_COVER=cov$SE.COVER/100
rea_sec$Mean_JuvColDen_cm2=  rea_sec$Mean_JuvColDen/10^4 #convert mean juv col density to cm2
rea_sec$SE_JuvColDen_cm2=  rea_sec$SE_JuvColDen/10^4 #convert juv col den SE to cm2
#Calculate sector level stock recruitment and propagate error
#sector level recruitment for sectors for this study
covcol=c("ANALYSIS_SEC","ANALYSIS_YEAR","Genus","N.COVER","P_COVER","SE.P_COVER")
Jsec_P_Asec= rea_sec %>%
filter(ANALYSIS_SEC%in%uSec&Genus%in%c("SSSS","MOSP","POSP","POCS","ACSP")) %>% #filter by target taxa and target sectors (uSec is unique sector list from above)
select(REGION,ISLAND,ANALYSIS_SEC,ANALYSIS_YEAR,Genus,Mean_JuvColDen_cm2, SE_JuvColDen_cm2,N.JCD)%>%
left_join(cov[,covcol],by=c("ANALYSIS_SEC","ANALYSIS_YEAR","Genus")) %>%
left_join(PropRecMn,by=c("Genus"="Genus")) %>%
group_by(REGION,ISLAND,ANALYSIS_SEC,ANALYSIS_YEAR,Genus)%>%
mutate(Mean_JuvColDenP=Mean_JuvColDen_cm2*meanPropRec,
SE_JuvColDenP=SE_JuvColDen_cm2*meanPropRec,
N.JCDp=N.JCD,
SD_JuvColDenP=sqrt(N.JCDp)*SE_JuvColDenP,
SD.P_COVER=sqrt(N.COVER)*SE.P_COVER,
MN.RecVal = Mean_JuvColDenP/P_COVER,
SE.RecVal = MN.RecVal*sqrt((SE_JuvColDenP/Mean_JuvColDenP)^2+(SE.P_COVER/P_COVER)^2),#propogating SE error
N.RecVal = min(N.JCDp,N.COVER,na.rm=T),
#SE.RecVal = SD.RecVal/sqrt(N.RecVal),
CI95.RecVal = 1.96*SE.RecVal,
LOW_CI95.RecVal= MN.RecVal - CI95.RecVal,
HIGH_CI95.RecVal= MN.RecVal + CI95.RecVal
)
write.csv(Jsec_P_Asec,file = "./Data/RecruitmentData/RecVal_NCRMP.Obs_VRSector.csv")
#sector level recruitment for all sectors across ncrmp (not just study sectors)
Jsec_P_ALL= rea_sec %>%
filter(Genus%in%c("SSSS","MOSP","POSP","POCS","ACSP")) %>% #uSec is unique sector list from above
select(REGION,ISLAND,ANALYSIS_SEC,ANALYSIS_YEAR,Genus,Mean_JuvColDen_cm2, SE_JuvColDen_cm2,N.JCD)%>%
left_join(cov[,covcol],by=c("ANALYSIS_SEC","ANALYSIS_YEAR","Genus")) %>%
left_join(PropRecMn,by=c("Genus"="Genus")) %>%
group_by(REGION,ISLAND,ANALYSIS_SEC,ANALYSIS_YEAR,Genus)%>%
mutate(Mean_JuvColDenP=Mean_JuvColDen_cm2*meanPropRec,
SE_JuvColDenP=SE_JuvColDen_cm2*meanPropRec,
N.JCDp=N.JCD,
SD_JuvColDenP=sqrt(N.JCDp)*SE_JuvColDenP,
SD.P_COVER=sqrt(N.COVER)*SE.P_COVER,
MN.RecVal = Mean_JuvColDenP/P_COVER,
SE.RecVal = MN.RecVal*sqrt((SE_JuvColDenP/Mean_JuvColDenP)^2+(SE.P_COVER/P_COVER)^2),#propogating SE error
N.RecVal = min(N.JCDp,N.COVER,na.rm=T),
#SE.RecVal = SD.RecVal/sqrt(N.RecVal),
CI95.RecVal = 1.96*SE.RecVal,
LOW_CI95.RecVal= MN.RecVal - CI95.RecVal,
HIGH_CI95.RecVal= MN.RecVal + CI95.RecVal
)
write.csv(Jsec_P_Asec,file = "./Data/RecruitmentData/RecVal_NCRMP.Obs_AllNCRMPSector.csv")
Jsec_P_ALL %>% #filter(ISLAND%in%c("Hawaii","Maui","Oahu","French Frigate","Lisianski","Kure")) %>%
ggplot(aes(MN.RecVal))+
geom_histogram(binwidth=0.001)+
facet_grid(ISLAND~Genus,scales="free_y")+xlim(c(0,quantile(Jsec_P_ALL$MN.RecVal,.95,na.rm=T)))
#View(Jsec_P_Asec)
#rec values by region and genus code
RecVal_Sec_Dists=Jsec_P_ALL %>% filter(!is.infinite(MN.RecVal)) %>%
group_by(REGION,Genus) %>%
summarize(MD.RecVal_Sec_All=median(MN.RecVal,na.rm=T),
MD.CI95_LO.RecVal_Sec_All=median(MN.RecVal-1.96*SE.RecVal,na.rm=T),
MD.CI95_HI.RecVal_Sec_All=median(MN.RecVal+1.96*SE.RecVal,na.rm=T),
MN.RecVal_Sec_All=mean(MN.RecVal,na.rm=T),
MN.CI95_LO.RecVal_Sec_All=mean(MN.RecVal-1.96*SE.RecVal,na.rm=T),
MN.CI95_HI.RecVal_Sec_All=mean(MN.RecVal+1.96*SE.RecVal,na.rm=T)
)
write.csv(RecVal_Sec_Dists,file = "./Data/RecruitmentData/RecVal_NCRMP.Obs_AllNCRMPSector_Genus.REGIONSummary.csv")
Jsec_P_ALL %>% #filter(ISLAND%in%c("Hawaii","Maui","Oahu","French Frigate","Lisianski","Kure")) %>%
ggplot(aes(MN.RecVal))+
geom_histogram(binwidth=0.01)+
geom_vline(aes(xintercept=MD.RecVal_Sec_All),data=RecVal_Sec_Dists,color="darkcyan",lty=1)+
geom_vline(aes(xintercept=MD.CI95_LO.RecVal_Sec_All),data=RecVal_Sec_Dists,color="darkcyan",lty=3)+
geom_vline(aes(xintercept=MD.CI95_HI.RecVal_Sec_All),data=RecVal_Sec_Dists,color="darkcyan",lty=3)+
facet_grid(REGION~Genus)+
scale_x_sqrt()
#plot site-level stock recruitment values and sector-level stock recruitment values
Site=ggplot(RecSFMDataFrame,aes(RecSFM_p_SiteAdcm2_Yr))+
geom_histogram()+ theme_bw()+
facet_grid("Genus")+
#facet_wrap(Genus~REGION)+
xlim(c(0,.12)) + xlab("Site-level stock recruitment") # "# recruits  / area adult coral"
Sec= Jsec_P_Asec%>%
filter(Genus%in%c("MOSP","POSP","POCS")) %>%
ggplot(aes(MN.RecVal))+
geom_histogram()+theme_bw()+
facet_grid("Genus")+
#facet_wrap(Genus~REGION)+
xlim(c(0,.12))+ xlab("Proportional sector-level stock recruitment") # "Proportional juv. colony density / cover"
Site/Sec
#Sector Stock Rec for REGIONAL MODEL
Regional_SectorStockRec <- as.data.frame(Jsec_P_Asec)
Regional_SectorStockRec$MN.RecVal[Regional_SectorStockRec$MN.RecVal == Inf] <- NA
Regional_SectorStockRec$SE.RecVal[Regional_SectorStockRec$SE.RecVal == Inf] <- NA
Regional_SectorStockRec <- Regional_SectorStockRec %>%
select(ANALYSIS_SEC,ANALYSIS_YEAR,Genus,REGION,MN.RecVal,SE.RecVal)%>%
group_by(Genus, REGION) %>%
summarise(SectorStock_median = median(MN.RecVal,na.rm = TRUE),
SectorStock_MD_CI95_LO = median(MN.RecVal-1.96*SE.RecVal,na.rm=T),
SectorStock_MD_CI95_HI = median(MN.RecVal+1.96*SE.RecVal,na.rm=T),
SectorStock_mean = mean(MN.RecVal,na.rm = TRUE),
SectorStock_MN_CI95_LO = mean(MN.RecVal-1.96*SE.RecVal, na.rm = TRUE),
SectorStock_MN_CI95_HI = mean(MN.RecVal+1.96*SE.RecVal, na.rm = TRUE)
)
#change negative low CI values to 0 since you can't have negative recruitment
Regional_SectorStockRec[Regional_SectorStockRec<0] = 0
#Include Sec_All values in Regional sector stock
Regional_SectorStockRec <- left_join(Regional_SectorStockRec,RecVal_Sec_Dists, by= c("Genus","REGION"))
write.csv(Regional_SectorStockRec,file = "./Data/RecruitmentData/Regional_Sector_VRSectorObs_AllSectorObs_GRSummary_2026.csv")
############################################################################
#Compile All Available RecVal estimates for each VRSector
#Start with all ColTrans SIGs
metacol=c("REGION","Island","SEC_NAME","SIG","Site","Interval","Genus","Interval_Years")
SIGcol=c("Site","Interval","Genus")
RecComp=unique(ColTrans[,c(metacol)])
RecComp=RecComp %>% rename(ISLANDCODE=Island)
RecComp$ISLAND=SecIslLU[RecComp$SEC_NAME]
SFMRecValcol=c("RecSFM_p_SiteAdcm2_Yr")
#Got to push SFM obs into next interval for recruitment values
MergeSFM=RecSFMDataFrame[,c(metacol,SFMRecValcol)]
MergeSFM=MergeSFM %>% rename(DataInterval=Interval)
for (i in 1:nrow(MergeSFM)){
thissite=MergeSFM %>% filter(Site==MergeSFM$Site[i])
uI=sort(unique(thissite$DataInterval))
MergeSFM$RecInterval[i]=uI[which(MergeSFM$DataInterval[i]==uI)+1]
}
MergeSFM=MergeSFM %>% rename(Interval=RecInterval) %>% dplyr::select(-DataInterval)
#Add SFM rec to proper Interval
RecComp=RecComp %>% left_join(MergeSFM[c(SIGcol,SFMRecValcol)]) %>%
rename(SFMObs.SiteYrRecVal=RecSFM_p_SiteAdcm2_Yr)
#Add NCRMP RecVal at sector scale
RecComp$ANALYSIS_YEAR=(paste0("20",substr(RecComp$Interval,1,2)))
recvalcol=c("MN.RecVal","SE.RecVal","N.RecVal","CI95.RecVal","LOW_CI95.RecVal","HIGH_CI95.RecVal")
RecComp = RecComp %>% left_join(Jsec_P_Asec[,c("ANALYSIS_SEC","ANALYSIS_YEAR","Genus",recvalcol)],
by=join_by(SEC_NAME==ANALYSIS_SEC,ANALYSIS_YEAR,Genus))
names(RecComp)=gsub(names(RecComp),pattern = "\\.RecVal",replacement = "\\.SecYrRecVal")
#Add NCRMP Mean Sector-Level across years
SecSum=Jsec_P_ALL %>% group_by(REGION,ISLAND,ANALYSIS_SEC,Genus) %>%
summarize(MN.SecSumRecVal=mean(MN.RecVal,na.rm=T),
SE.SecSumRecVal=sqrt(sum(SE.RecVal^2,na.rm=T))) %>% ungroup() %>%
dplyr::select(-REGION,-ISLAND)
RecComp=RecComp %>% left_join(SecSum,by=join_by(SEC_NAME==ANALYSIS_SEC,Genus))
#Add NCRMP island-year mean
islyrSum=Jsec_P_ALL %>%
group_by(REGION,ISLAND,ANALYSIS_YEAR,Genus) %>%
filter(!is.nan(MN.RecVal)) %>%
summarize(MN.ISLYR.RecVal=mean(MN.RecVal,na.rm=T),
SE.ISLYR.RecVal=sqrt(sum(SE.RecVal^2,na.rm=T))) %>%
ungroup() %>%
dplyr::select(-REGION)
RecComp=RecComp %>% left_join(islyrSum,by=join_by(ISLAND,ANALYSIS_YEAR,Genus))
#Add NCRMP region-year mean
regyrSum=Jsec_P_ALL %>%
mutate(REGION=ifelse(REGION=="PRIAs",
"PRIA",
ifelse(REGION%in%c("GUA","CNMI"),
"MARIAN",
REGION))) %>%
group_by(REGION,ANALYSIS_YEAR,Genus) %>%
filter(!is.nan(MN.RecVal)) %>%
summarize(MN.REGYR.RecVal=mean(MN.RecVal,na.rm=T),
SE.REGYR.RecVal=sqrt(sum(SE.RecVal^2,na.rm=T)))
RecComp=RecComp %>% left_join(regyrSum,by=join_by(REGION,ANALYSIS_YEAR,Genus))
write.csv(RecComp,file = "./Data/RecruitmentData/VRSite_RecruitmentMetricComparison_2026.csv")
